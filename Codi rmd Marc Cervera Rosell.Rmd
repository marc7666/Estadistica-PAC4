---
title: "Activitat 4"
author: "Marc Cervera Rosell"
date: "21-06-2024"
output: pdf_document
---

```{r}
setRepositories(ind=2) # Per descarregar paquets de CRAN
```

# 1 Preprocessament

## 1.1 Variables Income i Year_Birth

```{r}
tryCatch({
  data <- read.csv("marketing.csv", header = TRUE)
  print("Fitxer llegit correctament")
}, error = function(e){
  cat("ERROR en la lectura del fitxer:",conditionMessage(e),"\n")
})
```

```{r}
columns <- names(data)
type <- sapply(data, class)
for (i in seq_along(columns)) {
  cat("La columna", columns[i], "és de tipus", type[i], "\n")
}
```

Després d'observar els tipus de les variables del conjunt de dades, solament es procedirà a fer un canvi de tipus. Aquest canvi es produirà en la variable _Dt_Customer_ que passarà de ser de tipus _character_ a tipus _date_.

```{r}
data_transformed <- transform(data,
                              Dt_Customer = as.Date(Dt_Customer))
```

```{r}
columns <- names(data_transformed)
type <- sapply(data_transformed, class)
for (i in seq_along(columns)) {
  cat("La columna", columns[i], "és de tipus", type[i], "\n")
}
```

S'observa que després de l'aplicació de la funció _transform()_ el tipus de la variable _Dt_Customer_ queda modificat.

Finalment, cal excloure les variables _Z_CostContact_ i _Z_Revenue_, atès que són variables de control i que així s'indica a l'enunciat de l'activitat.

```{r}
columns_to_exclude <- c("Z_CostContact", "Z_Revenue")
data_with_no_control_variables <- data_transformed[, !(names(data_transformed) %in%
                                                         columns_to_exclude)]
print(names(data_with_no_control_variables))
```

S'observa que en treure per pantalla les columnes del _dataset_ _data_with_no_control_variables_ les variables de control indicades anteriorment ja no hi són. Per tant, aquest conjunt final queda completament operatiu per a poder treballar.

## 1.2 Valors absents

Abans de res, encara que l'enunciat ja ho diu, és bona pràctica comprovar si realment hi ha valors absents.

```{r}
any(is.na(data_with_no_control_variables$Income))
any(is.na(data_with_no_control_variables$Year_Birth))
```
```{r}
library(VIM)
```

Primer cal seleccionar aquelles variables que s'usaran per al càlcul de la distància de Gower. Com s'especifica en l'enunciat seran les variables 10 a 15.

```{r}
variables_gower <- c("MntWines", "MntFruits", "MntMeatProducts", "MntFishProducts",
                     "MntSweetProducts", "MntGoldProds")
```

Com s'indica en les instruccions de l'activitat en desenvolupament, per imputar els valors _NA_ de la varible _Income_ s'aplica la funció _kNN_ de la llibreria _VIM_.

```{r}
income_imputed <- kNN(data_with_no_control_variables, variable = "Income",
                      dist_var = variables_gower, k = 5)
```

Un cop aplicada la funció _kNN_ s'observa que la variable _Income_ ja no té valors _NA_

```{r}
any(is.na(income_imputed$Income))
```

En primer lloc, abans de calcular la mitjana d'edat cal seleccionar les persones que són vídues.

```{r}
widowed_people <- subset(income_imputed, Marital_Status == "Widow")
```

Un cop seleccionades aquestes persones ja es pot procedir al càlcul de la mitjana d'edat.

```{r}
mean_widow_age <- mean(widowed_people$Year_Birth)
cat("L'edat mitjana de les persones vidues és:", round(mean_widow_age))
```

```{r}
income_imputed$Year_Birth <- ifelse(is.na(income_imputed$Year_Birth), mean_widow_age,
                                    income_imputed$Year_Birth)
```

```{r}
any(is.na(income_imputed$Year_Birth))
```

S'observa que després de l'execució de la cel·la que conté la sentència _ifelse_ els valors _NA_ de la variable _Year_Birth_ ja no són tals.

```{r}
any(is.na(income_imputed))
```

Un cop eliminats els valors _NA_ de les variables _Income_ i _Year_Birth_ es pot observar (en la cel·la anterior) el conjunt de dades queda completament lliure de valors _NA_, per tant, cal redenominar aquest conjunt a _markclean_.

```{r}
markclean <- income_imputed
```

Finalment, es demana una reflexió sobre el nombre de valors _NA_ del fitxer, per tant, cal, en primer lloc, comptar aquests valors.

```{r}
na_per_column <- colSums(is.na(data_with_no_control_variables))
total_na_values <- sum(na_per_column)
cat("El nombre total de valors NA és:", total_na_values)
```

Tot i que el nombre de valors _NA_ del fitxer no és considerablement elevat, és important abordar aquests valors. El fet de l'existència de valors _NA_ pot ser un indicador de problemes en les dades com: problemes en el moment de la recollida de les dades o senzillament que en el moment d'introduir les dades en el fitxer s'ha comès error humà. Com s'acaba d'esmentar, malgrat que el nombre de valors absents no és molt significatiu, és molt important gestionar aquests buits per evitar problemes en les anàlisis que es puguin arribar a fer tant en aquesta activitat com les anàlisis que pugui fer una altra persona completament aliena a la UOC.

# 2 Estadística descriptiva

## 2.1 Income

```{r}
mean_abs <- abs(mean(markclean$Income))
standard_deviation <- sd(markclean$Income)
coeffitient_of_variation <- standard_deviation / mean_abs
cat("El coeficient de variació de la variable Income és:", coeffitient_of_variation)
```

Es pot observar un coeficient de variació de 0.4824468. Això indica que, efectivament, existeix una variabilitat en la distribució, però que no és excessiva. Per tant, l'ingrés mitjà sí que és un valor representatiu de la distribució dels ingressos.

Per respondre a la segona pregunta cal, prèviament, utilitzar alguna eina per visualitzar la distribució de les dades de la variable. En aquest cas s'ha escollit veure la distribució en un gràfic de densitat. També s'introduirà una campana de Gauss (densitat normal) de les dades d'estudi per veure com de lluny estan de distribuir-se de manera normal.

```{r}
plot(density(markclean$Income),
     main = "Distribucio de la variable Income",
     xlab = "Valors",
     ylab = "Densitat",
     col = "blue",
     lwd = 2)
values_normal_distribution <- seq(min(markclean$Income), max(markclean$Income),
                                  length = 100)
normal_distribution <- dnorm(values_normal_distribution, mean = mean_abs,
                             sd = standard_deviation) # Campana de Gauss de les dades
lines(values_normal_distribution, normal_distribution, col = "red", lwd = 2)
```

Després d'observar ambdós gràfics, es pot observar que les dades no normalitzades (línia blava) no segueixen una distribució normal atès que la forma de la corba en el gràfic de densitat queda molt allunyada de la forma de la línia vermella que representa les dades normalitzades.

## 2.2 Education

```{r}
library(dplyr)
library(ggplot2)
library(magrittr) # Per l'operador %>%
```

L'operador "%>%" és un operador que crea un _pipe_ i permet que el resultat d'una funció passi com a primer argument de la següent funció.

```{r}
markclean %>%
  group_by(Education) %>%
  summarize(
    mean_value = mean(Income),
    observations = n(),
    deviation = sd(Income)
  ) %>%
  arrange(desc(Education))
```

```{r}
markclean %>%
  arrange(desc(Education)) %>%
  ggplot(aes(x = Education, y = Income)) +
  geom_boxplot() + 
  labs(x = "Education", y = "Income", tittle = "Ingressos segons nivell educatiu")
```

En primer lloc, es pot observar que la posició de la mediana (línia interna de la caixa), es troba just al centre en els nivells educatius "Graduation", "Master" i "PhD", per tant, en aquests tres casos es pot concloure que el 50% dels valors estan per sota de la mediana i l'altre 50% per sobre. Per als nivells educatius "2n Cycle" i "Basic", es pot observar que en el cas del primer nivell educatiu comentat, la línia de la mediana es troba lleugerament desplaçada a la part superior de la caixa i en el cas del nivell "Basic" la línia de la mediana està a la part superior de la caixa, per tant, en aquests dos casos les dades presenten una asimetria positiva cosa que indica que la majoria de les dades es troben a l'esquerra de la mediana. El fet de tenir una asimetria positiva és indicatiu, en aquest cas, que una petita proporció de persones tenen més ingressos que la majoria de les persones del mateix nivell educatiu.

Observant els bigotis de les caixes, es pot veure que n'hi ha de més curt i de més llargs. Segons la longitud dels bigotis de cada caixa, es podrà veure com d'agrupades estan les dades, és a dir, es podrà observar com són de dispersos els valors extrems. Per interpretar els bigotis de les caixes cal mirar la seva longitud. Com més llargs siguin els bigotis més dispersos estaran els valors extrems, és a dir, els valors extrems estaran més lluny de la resta de valors. Per contra, com més curts siguin els bigotis de les caixes, menys dispersos estaran els valors extrems i, per tant, més propers estaran a la resta de valors.

Finalment, s'observa la presència de valors atípics. Els valors atípics són els punts que estan situats fora dels bigotis, però això no significa que no siguin valors importants.